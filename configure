#!/bin/bash
# Emacs please make this -*- mode: shell-mode; -*-

uname=$(type -P uname)
if [ "${uname}" = "" ]; then
    echo "You do not have uname so this is unlikely to be a Unix system. Exiting."
    exit -1
fi

## should also test for BBG header and library

arch=$(uname -m)
if [ "${arch}" = "x86_64" ]; then
    echo "Setting up compilation for 64-bit system"
    sed -e's/@config@/blpapi3_64/' src/Makevars.in > src/Makevars
elif [ "${arch}" = "i686" ]; then
    echo "Setting up compilation for 32-bit system"
    sed -e's/@config@/blpapi3_32/' src/Makevars.in > src/Makevars
else 
    echo "Unknown architecture: ${arch}. Exiting."
    exit -1
fi

## if on Travis CI, fetch tarball from Bloomberg and install shared library
if [ "${TRAVIS}" = "true" ]; then
    file="http://static.bloomberglabs.com/api/cpp/blpapi_cpp_3.8.8.1-linux.tar.gz"
    basefile=$(basename ${file})
    release=$(basename ${basefile} -linux.tar.gz)
    
    tempdir=$(mktemp --directory --suffix blp)
    cd ${tempdir}
    wget ${file}
    tar xfz ${basefile}
    
    if [ "${arch}" = "x86_64" ]; then
        cp -vax ${release}/Linux/libblpapi3_64.so /usr/local/lib 
    elif [ "${arch}" = "i686" ]; then
        cp -vax ${release}/Linux/libblpapi3_32.so /usr/local/lib 
    else 
        echo "Unknown architecture: ${arch}. Exiting."
        exit -1
    fi
    
    ## update ldconfig cache
    ldconfig
    cd .. && rm -rf ${tempdir}
fi
    
exit 0
